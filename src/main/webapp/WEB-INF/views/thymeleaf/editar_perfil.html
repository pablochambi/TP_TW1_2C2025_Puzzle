<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Editar Perfil</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <!-- Bootstrap -->
  <link rel="stylesheet" th:href="@{/webjars/bootstrap/5.2.0/css/bootstrap.min.css}"/>
  <link rel="stylesheet" th:href="@{/webjars/bootstrap-icons/1.11.3/font/bootstrap-icons.css}"/>

  <link rel="stylesheet" th:href="@{/css/editar_perfil.css}"/>
  <link rel="stylesheet" th:href="@{/css/home.css}"/>

  <style>
    .avatar-name {
      font-family: 'Poppins', sans-serif;
      color: #333;
      font-size: 1rem;
    }
    .emoji-avatar {
      font-size: 78px;
    }
    .avatar-premium img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 50%;
    }
  </style>
</head>
<body>
<div th:replace="fragment/header :: header"></div>

<div class="container">

  <!-- Header -->
  <div class="page-header">
    <h1 class="page-title">Editar Perfil</h1>
  </div>

  <!-- FORMULARIO ÚNICO -->
  <form id="perfilForm" method="post" th:action="@{/perfil/guardar}">

    <!-- Nav Tabs -->
    <ul class="nav nav-tabs" id="perfilTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="datos-tab" data-bs-toggle="tab"
                data-bs-target="#datos" type="button" role="tab"
                aria-controls="datos" aria-selected="true">
          Datos de Usuario
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="avatar-tab" data-bs-toggle="tab"
                data-bs-target="#avatar" type="button" role="tab"
                aria-controls="avatar" aria-selected="false">
          Avatar
        </button>
      </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="perfilTabsContent">

      <!-- TAB 1: DATOS DE USUARIO -->
      <div class="tab-pane fade show active" id="datos" role="tabpanel" aria-labelledby="datos-tab">
        <div class="edit-form mt-4">
          <!-- Username -->
          <div class="form-group">
            <label class="form-label" for="username">&#x1F464; Nombre de Usuario</label>
            <input type="text" class="form-input" id="username" name="nombreUsuario"
                   th:value="${usuario.nombreUsuario}"
                   placeholder="Ingresa tu nombre de usuario"
                   maxlength="30" required>
            <div class="form-help">Cambiar el nombre actualizará el avatar de letra automáticamente</div>
          </div>

          <!-- Email (no editable) -->
          <div class="form-group">
            <label class="fixed-label">&#x1F4E7; Email</label>
            <div class="fixed-field">
              <span th:text="${usuario.email}"></span>
              <div class="fixed-note">El email no se puede modificar por seguridad</div>
            </div>
          </div>

          <!-- Password -->
          <div class="form-group">
            <label class="form-label" for="password">&#128274; Contraseña</label>
            <div class="password-group">
              <input type="password" class="form-input" id="password" name="password"
                     th:value="${usuario.password}" placeholder="Ingresa tu nueva contraseña"
                     minlength="3" required>
              <button type="button" class="show-pass-btn" onclick="togglePassword()">&#128065;&#65039;</button>
            </div>
            <div class="form-help">Mínimo 3 caracteres. Incluye números y letras para mayor seguridad</div>
          </div>
        </div>
      </div>

      <!-- TAB 2: AVATAR -->
      <div class="tab-pane fade" id="avatar" role="tabpanel" aria-labelledby="avatar-tab">
        <div class="mt-4">

          <!-- Card de Vista Previa -->
          <div class="card text-center mb-4">
            <div class="card-body">

              <!-- Avatar -->
              <div class="avatar text-center" id="avatarPreview">
                <img th:if="${usuario.avatar != null and usuario.avatar.urlImagen != null}"
                     th:src="@{${usuario.avatar.urlImagen}}"
                     alt="Avatar del usuario"
                     class="img-fluid rounded-circle">

                <span th:if="${usuario.avatar != null and usuario.avatar.urlImagen == null}"
                      th:utext="${usuario.avatar.iconoHexadecimal}"
                      class="emoji-avatar"></span>

                <span th:if="${usuario.avatar == null}"
                      th:text="${#strings.substring(usuario.nombreUsuario,0,1).toUpperCase()}"
                      class="emoji-avatar"></span>
              </div>

              <div class="caja-datos">
                <h5 class="card-title" th:text="${usuario.nombreUsuario}">Usuario</h5>
                <p class="card-text" th:text="${usuario.email}">usuario@mail.com</p>
              </div>

              <input type="hidden" name="id_avatar" id="idAvatarInput"
                     th:value="${usuario.avatar != null ? usuario.avatar.id : 0}" />
            </div>
          </div>

          <!-- Avatares Gratis -->
          <h4 class="selection-title">&#x1F3A8; Avatares Gratis</h4>
          <div class="avatar-options mb-4">

            <!-- Avatar por defecto con inicial del nombre de usuario -->
            <div class="avatar-option letter-avatar selected"
                 data-type="letter"
                 th:data-value="${#strings.substring(usuario.nombreUsuario,0,1)}"
                 th:text="${#strings.substring(usuario.nombreUsuario,0,1)}"
                 title="Por defecto"
                 th:attr="data-avatar-id=0">
            </div>

            <!-- Iteración sobre los avatares gratis del backend -->
            <div th:each="avatar : ${lista_avatares}" th:if="${avatar.precio == 0}"
                 class="avatar-option"
                 th:data-type="${#strings.isEmpty(avatar.urlImagen) ? 'emoji' : 'premium'}"
                 th:data-value="${#strings.isEmpty(avatar.urlImagen) ? avatar.iconoHexadecimal : avatar.urlImagen}"
                 th:title="${avatar.nombre}"
                 th:attr="data-avatar-id=${avatar.id}">

              <!-- Si es emoji -->
              <span th:if="${#strings.isEmpty(avatar.urlImagen)}" th:utext="${avatar.iconoHexadecimal}"></span>

              <!-- Si es imagen -->
              <img th:if="${avatar.urlImagen != null}"
                   th:src="@{${avatar.urlImagen}}"
                   th:alt="${avatar.nombre}"
                   class="img-fluid rounded-circle"
                   style="width: 48px; height: 48px; object-fit: cover;">
            </div>

          </div>



          <!-- Avatares de Pago -->
          <h4 class="selection-title">&#x1F48E; Avatares Premium</h4>
          <div class="row g-3">
            <div class="col-6 col-md-3" th:each="avatar : ${lista_avatares}  "  th:if="${avatar.precio > 0}">
              <div class="card text-center p-2">

                <img th:src="@{${avatar.urlImagen}}"
                     class="card-img-top"
                     th:alt="${avatar.nombre}" />

                <div class="avatar-name mt-1 fw-semibold" th:text="${avatar.nombre}"></div>

                <button type="button"
                        th:if="${!avatar.comprado}"
                        class="btn btn-success comprar-btn mt-2 d-flex align-items-center justify-content-center"
                        th:attr="data-avatar-id=${avatar.id},
                                 data-avatar-name=${avatar.nombre},
                                 data-avatar-price=${avatar.precio},
                                 data-avatar-img=${#strings.substringAfter(avatar.urlImagen, '/img/')}">
                  <img th:src="@{/img/coin_master.png}" alt="Moneda" class="me-2">
                  <span th:text="${avatar.precio}"></span>
                </button>

                <button type="button"
                        th:if="${avatar.comprado}"
                        class="btn btn-primary usar-btn mt-2"
                        th:attr="data-avatar-id=${avatar.id},
                                 data-avatar-type='premium',
                                 data-avatar-img=${#strings.substringAfter(avatar.urlImagen, '/img/')}">
                  Usar
                </button>

              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Buttons -->
    <div class="form-buttons mt-4">
      <button type="submit" class="btn btn-success">&#x1F4BE; Guardar Cambios</button>
      <a th:href="@{/perfil}" class="btn btn-secondary">&larr; Volver al Perfil</a>
    </div>
  </form>

</div>

<!-- Modal de Confirmación de Compra -->
<div class="modal fade" id="confirmCompraModal" tabindex="-1" aria-labelledby="confirmCompraModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="confirmCompraModalLabel">Confirmar Compra</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img id="modalAvatarImg" src="" alt="Avatar" style="width: 100px; height: 100px; border-radius: 50%; margin-bottom: 15px;">
        <h5 id="modalAvatarName" class="mb-3">Nombre del Avatar</h5>
        <div class="d-flex align-items-center justify-content-center mb-3">
          <img th:src="@{/img/coin_master.png}" alt="Moneda" style="width: 30px; height: 30px;" class="me-2">
          <span id="modalAvatarPrice" style="font-size: 24px; font-weight: bold;">50</span>
        </div>
        <p class="text-muted">¿Deseas comprar este avatar premium?</p>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <a href="#" class="btn btn-success" id="confirmarCompraBtn">Confirmar Compra</a>
      </div>
    </div>
  </div>
</div>

<script th:src="@{/webjars/bootstrap/5.2.0/js/bootstrap.bundle.min.js}"></script>
<script th:src="@{/js/editar_perfil.js}"></script>
<script th:src="@{/js/home.js}"></script>
</body>
</html>
