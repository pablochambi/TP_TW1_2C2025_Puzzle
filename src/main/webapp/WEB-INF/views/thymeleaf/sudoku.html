<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Sudoku</title>
  <link rel="stylesheet" th:href="@{/css/sudoku.css}"/>
</head>
<body>
<h2>Sudoku Puzzle</h2>

<table id="puzzle">
  <tbody>
  <tr th:each="row, rowStat : ${sudoku.puzzle}">
    <td th:each="cell, colStat : ${row}"
        th:utext="${cell != null ? cell : '<input type=&quot;text&quot; maxlength=&quot;1&quot;>'}">
    </td>
  </tr>
  </tbody>
</table>

<div style="text-align:center; margin: 20px;">
  <button onclick="checkSolution()">Verificar</button>
  <button onclick="showSolution()">Mostrar soluci贸n</button>
</div>

<h2>Sudoku Solution</h2>

<table id="solution" style="display:none;">
  <tbody>
  <tr th:each="row : ${sudoku.solution}">
    <td th:each="cell : ${row}" th:text="${cell}"></td>
  </tr>
  </tbody>
</table>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const puzzleTable = document.getElementById("puzzle");
    const solutionTable = document.getElementById("solution");

    const puzzleRows = puzzleTable.getElementsByTagName("tr");
    const solutionRows = solutionTable.getElementsByTagName("tr");

    // Asigna eventos a las celdas editables
    for (let i = 0; i < puzzleRows.length; i++) {
      const puzzleCells = puzzleRows[i].getElementsByTagName("td");
      for (let j = 0; j < puzzleCells.length; j++) {
        const input = puzzleCells[j].querySelector("input");
        if (input) {
          input.addEventListener("input", () => {
            const correctValue = solutionRows[i].getElementsByTagName("td")[j].innerText.trim();
            const userValue = input.value.trim();

            if (userValue === "") {
              input.classList.remove("correct", "wrong", "shake");
              return;
            }

            if (userValue === correctValue) {
              input.classList.add("correct");
              input.classList.remove("wrong", "shake");
            } else {
              input.classList.add("wrong", "shake");
              input.classList.remove("correct");

              // Quita la animaci贸n de vibraci贸n despu茅s de un instante
              setTimeout(() => input.classList.remove("shake"), 400);
            }

            checkIfSudokuIsComplete();
          });
        }
      }
    }

    function checkIfSudokuIsComplete() {
      let allCorrect = true;

      for (let i = 0; i < puzzleRows.length; i++) {
        const puzzleCells = puzzleRows[i].getElementsByTagName("td");
        const solutionCells = solutionRows[i].getElementsByTagName("td");

        for (let j = 0; j < puzzleCells.length; j++) {
          const input = puzzleCells[j].querySelector("input");
          if (input) {
            const userValue = input.value.trim();
            const correctValue = solutionCells[j].innerText.trim();
            if (userValue !== correctValue) {
              allCorrect = false;
              break;
            }
          }
        }
      }

      if (allCorrect) {
        launchConfetti();
        showCongratsMessage();
      }
    }

    //  Confeti visual
    function launchConfetti() {
      const duration = 2000;
      const end = Date.now() + duration;

      (function frame() {
        const confettiCount = 5;
        for (let i = 0; i < confettiCount; i++) {
          const confetti = document.createElement("div");
          confetti.className = "confetti";
          confetti.style.left = Math.random() * 100 + "vw";
          confetti.style.animationDuration = Math.random() * 1 + 1 + "s";
          document.body.appendChild(confetti);

          setTimeout(() => confetti.remove(), 2000);
        }
        if (Date.now() < end) requestAnimationFrame(frame);
      })();
    }

    //  Mensaje de felicitaci贸n flotante
    function showCongratsMessage() {
      const msg = document.createElement("div");
      msg.className = "congrats-message";
      msg.innerHTML = "&#x1F389; 隆Felicitaciones! Sudoku completado &#x1F389;";
      document.body.appendChild(msg);

      setTimeout(() => msg.classList.add("show"), 100);
      setTimeout(() => msg.classList.remove("show"), 3000);
      setTimeout(() => msg.remove(), 3500);
    }
  });

  function showSolution() {document.getElementById("solution").style.display = "table"; }


</script>

</body>
</html>