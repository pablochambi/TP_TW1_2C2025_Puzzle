<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
  <meta charset="UTF-8">
  <title>Sudoku</title>
  <link rel="stylesheet" th:href="@{/css/sudoku.css}">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f8f9fa;
      text-align: center;
      margin: 0;
      padding: 0;
    }

    h2 {
      margin-top: 20px;
    }

    table {
      border-collapse: collapse;
      margin: 20px auto;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    td {
      width: 45px;
      height: 45px;
      text-align: center;
      border: 1px solid #999;
      font-size: 18px;
      position: relative;
    }

    input {
      width: 100%;
      height: 100%;
      text-align: center;
      border: none;
      outline: none;
      font-size: 18px;
      background: white;
      cursor: pointer;
    }

    .correct {
      background-color: #c6f6d5 !important; /* verde */
    }

    .wrong {
      background-color: #feb2b2 !important; /* rojo */
    }

    .stats {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin-top: 10px;
      font-size: 18px;
    }

    .controls {
      margin-top: 20px;
    }

    button {
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      font-size: 16px;
      margin: 5px;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover {
      background-color: #0056b3;
    }

    /* Overlay de pausa */
    #pauseOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      font-size: 22px;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 10;
    }

    #pauseOverlay button {
      background-color: #28a745;
      margin-top: 15px;
    }

    #pauseOverlay button.exit {
      background-color: #dc3545;
    }

  </style>
</head>
<body>
<h2>üß© Sudoku</h2>

<div class="stats">
  <div>‚è±Ô∏è Tiempo: <span id="timer">00:00</span></div>
  <div>‚≠ê Puntos: <span id="score">0</span></div>
  <div>üí° Pistas: <span id="hints">5</span></div>
</div>

<!-- TABLERO -->
<table id="puzzle">
  <tbody>
  <tr th:each="row, rowStat : ${sudoku.puzzle}">
    <td th:each="cell, colStat : ${row}">
      <span th:if="${cell != null}" th:text="${cell}"></span>
      <input th:unless="${cell != null}"
             type="text" maxlength="1"
             th:attr="data-row=${rowStat.index}, data-col=${colStat.index}"
             oninput="handleInput(this)">
    </td>
  </tr>
  </tbody>
</table>

<!-- Soluci√≥n oculta -->
<table id="solution" style="display:none;">
  <tbody>
  <tr th:each="row : ${sudoku.solution}">
    <td th:each="cell : ${row}" th:text="${cell}"></td>
  </tr>
  </tbody>
</table>

<!-- Botones -->
<div class="controls">
  <button onclick="togglePause()">‚è∏Ô∏è Pausa</button>
  <button onclick="useHint()">üí° Pista</button>
  <button onclick="clearCell()">üßπ Borrar</button>
</div>

<!-- Overlay de Pausa -->
<div id="pauseOverlay">
  <div>‚è∏Ô∏è Juego en pausa</div>
  <button onclick="resumeGame()">Continuar</button>
  <button class="exit" onclick="exitGame()">Salir</button>
</div>

<script>
  let timerInterval;
  let seconds = 0;
  let isPaused = false;
  let score = 0;
  let hints = 5;
  let selectedInput = null;

  // Inicializa el juego
  document.addEventListener("DOMContentLoaded", () => {
    startTimer();
    document.querySelectorAll("#puzzle input").forEach(input => {
      input.addEventListener("focus", () => selectedInput = input);
    });
  });

  // Cron√≥metro
  function startTimer() {
    timerInterval = setInterval(() => {
      if (!isPaused) {
        seconds++;
        const mins = String(Math.floor(seconds / 60)).padStart(2, "0");
        const secs = String(seconds % 60).padStart(2, "0");
        document.getElementById("timer").textContent = `${mins}:${secs}`;
      }
    }, 1000);
  }

  function togglePause() {
    isPaused = !isPaused;
    const overlay = document.getElementById("pauseOverlay");
    overlay.style.display = isPaused ? "flex" : "none";
  }

  function resumeGame() {
    isPaused = false;
    document.getElementById("pauseOverlay").style.display = "none";
  }

  function exitGame() {
    const confirmExit = confirm("‚ö†Ô∏è ¬øSeguro que deseas salir? Perder√°s el progreso.");
    if (confirmExit) {
      window.location.href = "/spring/home";
    }
  }

  // Manejar input del usuario
  function handleInput(input) {
    const value = input.value.trim();
    const row = input.getAttribute("data-row");
    const col = input.getAttribute("data-col");

    if (!/^[1-9]$/.test(value)) {
      input.value = "";
      return;
    }

    const correctValue = document.getElementById("solution").rows[row].cells[col].innerText;

    if (value === correctValue) {
      input.classList.add("correct");
      input.classList.remove("wrong");
      score += 10;
      document.getElementById("score").textContent = score;
    } else {
      input.classList.add("wrong");
      input.classList.remove("correct");
    }
  }

  // Bot√≥n de borrar
  function clearCell() {
    if (selectedInput) {
      selectedInput.value = "";
      selectedInput.classList.remove("correct", "wrong");
    }
  }

  // Bot√≥n de pista
  function useHint() {
    if (hints <= 0) {
      alert("‚ö†Ô∏è No te quedan pistas disponibles.");
      return;
    }

    const emptyCells = Array.from(document.querySelectorAll("#puzzle input"))
            .filter(i => !i.value);

    if (emptyCells.length === 0) {
      alert("üéâ ¬°Ya completaste el Sudoku!");
      return;
    }

    const randomCell = emptyCells[Math.floor(Math.random() * emptyCells.length)];
    const row = randomCell.getAttribute("data-row");
    const col = randomCell.getAttribute("data-col");
    const correctValue = document.getElementById("solution").rows[row].cells[col].innerText;

    randomCell.value = correctValue;
    randomCell.classList.add("correct");
    randomCell.disabled = true;

    hints--;
    document.getElementById("hints").textContent = hints;
  }

  // Confirmar antes de recargar
  window.addEventListener("beforeunload", function (e) {
    e.preventDefault();
    e.returnValue = "Si recargas perder√°s tu progreso. ¬øDeseas continuar?";
  });
</script>

</body>
</html>
